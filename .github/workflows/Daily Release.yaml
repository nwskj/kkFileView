name: Java CI with Maven & Daily Release

# 触发条件：
# 1. 原有的 push/pull_request 到 master 分支
# 2. 每天北京时间00:00定时执行（UTC+8时区转换）
# 3. 手动触发（方便测试）
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 16 * * *'  # 北京时间00:00 = UTC16:00（核心定时配置）
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    steps:
      ##########################################################################
      # 步骤1：拉取代码（分两种场景：定时任务拉取官方源码，push/pull_request拉取当前仓库）
      ##########################################################################
      - name: 拉取官方kkFileView源码（定时/手动触发时）
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          repository: kekingcn/kkFileView  # 官方仓库地址
          ref: master                     # 拉取master分支（可改为指定版本，如v4.6.0）
          path: kkFileView                # 源码保存到kkFileView目录

      ##########################################################################
      # 步骤2：配置JDK 21（复用原有配置，增加缓存优化）
      ##########################################################################
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'  # 缓存Maven依赖，提速

      ##########################################################################
      # 新增：安装ARM64交叉编译工具链（用于构建ARM64架构产物）
      ##########################################################################
      - name: 安装ARM64交叉编译工具
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu  # ARM64编译器
          # 验证工具安装成功
          aarch64-linux-gnu-gcc --version

      ##########################################################################
      # 步骤3：缓存Maven依赖（复用原有配置，调整路径适配统一目录）
      ##########################################################################
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          # 基于官方/当前仓库的pom.xml生成缓存key，确保缓存有效性
          key: ${{ runner.os }}-maven-${{ hashFiles('kkFileView/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      ##########################################################################
      # 步骤4：Maven打包（新增ARM64最小化打包，不影响原有打包）
      ##########################################################################
      # 原有：x86_64标准打包（Linux/Windows）
      - name: Build x86_64 标准包
        run: |
          cd kkFileView  # 进入统一的源码目录
          mvn -B package -Dmaven.test.skip=true --file pom.xml
        env:
          MAVEN_OPTS: "-Dmaven.repo.local=~/.m2/repository"  # 指定依赖缓存目录

      # 新增：Linux ARM64 最小化打包（精简依赖、文档、示例，仅保留核心功能）
      - name: Build Linux ARM64 最小化包
        run: |
          cd kkFileView
          # 核心参数说明：
          # -Dtarget.arch=aarch64：指定ARM64架构
          # -Dcc/aarch64-linux-gnu-gcc：指定ARM64交叉编译器
          # -Dminimal.build=true：启用最小化构建（需项目pom支持，若无则用以下参数替代）
          # -Dskip.unnecessary.deps：跳过非核心依赖
          # -Dskip.doc/examples：跳过文档和示例文件
          mvn -B package -Dmaven.test.skip=true \
            -Dtarget.arch=aarch64 \
            -Dcc=aarch64-linux-gnu-gcc \
            -Dcxx=aarch64-linux-gnu-g++ \
            -Dminimal.build=true \
            -Dskip.unnecessary.deps=true \
            -Dskip.doc=true \
            -Dskip.examples=true \
            --file pom.xml
        env:
          MAVEN_OPTS: "-Dmaven.repo.local=~/.m2/repository"

      ##########################################################################
      # 新增：产物重命名（区分架构和打包类型，避免冲突）
      ##########################################################################
      - name: 产物重命名（区分x86_64和ARM64）
        run: |
          cd kkFileView/server/target
          
          # 重命名x86_64 Linux包（添加架构标识）
          for tar in *.tar.gz; do
            if [[ $tar != *arm64* ]]; then
              mv "$tar" "$(basename "$tar" .tar.gz)-x86_64.tar.gz"
            fi
          done
          
          # 重命名ARM64最小化包（明确标识架构和最小化）
          for tar in *.tar.gz; do
            if [[ $tar == *aarch64* || $tar == *arm64* ]]; then
              mv "$tar" "$(basename "$tar" .tar.gz)-arm64-minimal.tar.gz"
            fi
          done
          
          # Windows包保持原有命名（仅x86_64）
          for zip in *.zip; do
            mv "$zip" "$(basename "$zip" .zip)-x86_64.zip"
          done

      ##########################################################################
      # 步骤5：上传产物到Artifacts（新增ARM64最小化包）
      ##########################################################################
      - name: Upload Linux x86_64 标准包
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-linux-x86_64
          path: kkFileView/server/target/*-x86_64.tar.gz
          retention-days: 7

      - name: Upload Windows x86_64 标准包
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-windows-x86_64
          path: kkFileView/server/target/*-x86_64.zip
          retention-days: 7

      - name: Upload Linux ARM64 最小化包
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-linux-arm64-minimal
          path: kkFileView/server/target/*-arm64-minimal.tar.gz
          retention-days: 7

      ##########################################################################
      # 步骤6：仅定时/手动触发时，发布到Releases（包含ARM64最小化包）
      ##########################################################################
      - name: 生成Release版本号（基于当前时间）
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        id: generate-version
        run: |
          DATE=$(date +%Y%m%d)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "VERSION=daily-build-$DATE-$TIMESTAMP" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV  # 存储日期供后续使用

      - name: 创建Release并上传所有产物
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}  # 唯一标签（避免重复发布）
          name: 每日构建-${{ env.VERSION }}
          body: |
            📅 构建日期：${{ env.DATE }}
            🔗 源码来源：kekingcn/kkFileView@master
            📦 包含产物：
            - Linux x86_64 标准包（.tar.gz）- 完整功能版本
            - Windows x86_64 标准包（.zip）- 完整功能版本
            - Linux ARM64 最小化包（.tar.gz）- 精简版，适用于ARM64设备（树莓派4、ARM云服务器等）
            ⚠️  此为每日自动构建版本，非官方正式发布，仅供测试使用
            📝 最小化包说明：
            - 移除非核心依赖、文档、示例文件，减小包体积
            - 保留核心文件预览功能，兼容主流格式（文档、图片、视频等）
            - 适配ARM64架构，适合嵌入式/边缘设备部署
          draft: false  # 直接发布（非草稿）
          prerelease: true  # 标记为预发布（区分正式版本）
          # 上传所有产物（包含新增的ARM64最小化包）
          files: |
            kkFileView/server/target/*-x86_64.tar.gz
            kkFileView/server/target/*-x86_64.zip
            kkFileView/server/target/*-arm64-minimal.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供的令牌
