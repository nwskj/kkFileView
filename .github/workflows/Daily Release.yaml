name: Java CI with Maven & Daily Release

# è§¦å‘æ¡ä»¶ï¼šä¿æŒåŸæœ‰é…ç½®
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 16 * * *'  # åŒ—äº¬æ—¶é—´00:00 = UTC16:00
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å…³é”®ï¼šæˆäºˆåˆ›å»ºReleaseçš„æƒé™ï¼ˆä¿®å¤403é”™è¯¯ï¼‰
    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ï¼ˆä¼˜åŒ–è·¯å¾„å¤„ç†ï¼Œç¡®ä¿ç»Ÿä¸€ç›®å½•ï¼‰
      ##########################################################################
      - name: æ‹‰å–ä»£ç ï¼ˆåŒºåˆ†è§¦å‘åœºæ™¯ï¼‰
        uses: actions/checkout@v4
        with:
          # å®šæ—¶/æ‰‹åŠ¨è§¦å‘ï¼šæ‹‰å–å®˜æ–¹ä»“åº“ï¼›push/pull_requestï¼šæ‹‰å–å½“å‰ä»“åº“
          repository: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' ? 'kekingcn/kkFileView' : github.repository }}
          ref: master
          path: kkFileView  # ç»Ÿä¸€æºç ç›®å½•ï¼škkFileView

      ##########################################################################
      # æ­¥éª¤2ï¼šé…ç½®JDK 21ï¼ˆä¿æŒåŸæœ‰ç¼“å­˜ä¼˜åŒ–ï¼‰
      ##########################################################################
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      ##########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…ARM64äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆè¡¥å……ä¾èµ–ï¼Œç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®Œæ•´ï¼‰
      ##########################################################################
      - name: å®‰è£…ARM64äº¤å‰ç¼–è¯‘å·¥å…·åŠä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            make \
            cmake  # è¡¥å……ç¼–è¯‘ä¾èµ–ï¼ˆéƒ¨åˆ†é¡¹ç›®éœ€è¦ï¼‰
          # éªŒè¯å·¥å…·å®‰è£…
          aarch64-linux-gnu-gcc --version || { echo "ARM64ç¼–è¯‘å™¨å®‰è£…å¤±è´¥"; exit 1; }

      ##########################################################################
      # æ­¥éª¤4ï¼šMavenç¼“å­˜ï¼ˆä¿æŒåŸæœ‰é…ç½®ï¼‰
      ##########################################################################
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('kkFileView/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      ##########################################################################
      # æ­¥éª¤5ï¼šMavenæ‰“åŒ…ï¼ˆä¿®å¤ARM64æ„å»ºé€»è¾‘ï¼Œç¡®ä¿äº§ç‰©ç”Ÿæˆï¼‰
      ##########################################################################
      # åŸæœ‰ï¼šx86_64æ ‡å‡†æ‰“åŒ…ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Build x86_64 æ ‡å‡†åŒ…
        run: |
          cd kkFileView
          mvn -B package -Dmaven.test.skip=true --file pom.xml
        env:
          MAVEN_OPTS: "-Dmaven.repo.local=~/.m2/repository"

      # ä¿®å¤ï¼šARM64æœ€å°åŒ–æ‰“åŒ…ï¼ˆå…³é”®ä¼˜åŒ–ï¼‰
      - name: Build Linux ARM64 æœ€å°åŒ–åŒ…
        run: |
          cd kkFileView
          # æ ¸å¿ƒä¼˜åŒ–ï¼š
          # 1. ç§»é™¤å¯èƒ½ä¸è¢«é¡¹ç›®æ”¯æŒçš„è‡ªå®šä¹‰å‚æ•°ï¼ˆé¿å…æ„å»ºå¤±è´¥ï¼‰
          # 2. æ˜ç¡®æŒ‡å®šæ¶æ„ç¼–è¯‘å‚æ•°ï¼ˆé€‚é…å¤§å¤šæ•°Javaé¡¹ç›®çš„äº¤å‰ç¼–è¯‘é€»è¾‘ï¼‰
          # 3. æœ€å°åŒ–é€šè¿‡æ’é™¤ä¸å¿…è¦æ¨¡å—å®ç°ï¼ˆæ›´é€šç”¨ï¼Œæ— éœ€é¡¹ç›®pomç‰¹æ®Šæ”¯æŒï¼‰
          mvn -B package -Dmaven.test.skip=true \
            -Darch=aarch64 \
            -Dplatform=linux \
            -DskipTests \
            -DexcludeModuleNames=examples,docs,demo \  # æ’é™¤ç¤ºä¾‹ã€æ–‡æ¡£æ¨¡å—ï¼ˆæœ€å°åŒ–ï¼‰
            -Dmaven.javadoc.skip=true \  # è·³è¿‡javadocç”Ÿæˆ
            --file pom.xml
        env:
          MAVEN_OPTS: "-Dmaven.repo.local=~/.m2/repository"
          # äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡ï¼ˆéƒ¨åˆ†é¡¹ç›®ä¾èµ–æ­¤å˜é‡è¯†åˆ«ç¼–è¯‘å™¨ï¼‰
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++

      ##########################################################################
      # æ­¥éª¤6ï¼šäº§ç‰©æ£€æŸ¥ä¸é‡å‘½åï¼ˆæ–°å¢äº§ç‰©æ£€æŸ¥ï¼Œé¿å…ç©ºæ–‡ä»¶ï¼‰
      ##########################################################################
      - name: äº§ç‰©æ£€æŸ¥ä¸é‡å‘½å
        run: |
          cd kkFileView/server/target
          
          # æ‰“å°ç›®å½•ä¸‹æ‰€æœ‰äº§ç‰©ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯ä¿ç•™ï¼‰
          echo "å½“å‰äº§ç‰©åˆ—è¡¨ï¼š"
          ls -l *.tar.gz *.zip
          
          # é‡å‘½åx86_64äº§ç‰©ï¼ˆæ ‡å‡†åŒ…ï¼‰
          for tar in *.tar.gz; do
            # æ’é™¤ARM64äº§ç‰©ï¼Œåªå¤„ç†x86_64
            if ! echo "$tar" | grep -qiE "aarch64|arm64"; then
              mv "$tar" "$(basename "$tar" .tar.gz)-x86_64.tar.gz"
            fi
          done
          
          # é‡å‘½åARM64äº§ç‰©ï¼ˆæœ€å°åŒ–åŒ…ï¼‰
          # é€‚é…ä¸¤ç§å¯èƒ½çš„äº§ç‰©å‘½åï¼šå«aarch64æˆ–arm64
          for tar in *.tar.gz; do
            if echo "$tar" | grep -qiE "aarch64|arm64"; then
              mv "$tar" "$(basename "$tar" .tar.gz)-arm64-minimal.tar.gz"
            fi
          done
          
          # Windowsäº§ç‰©é‡å‘½åï¼ˆx86_64ï¼‰
          for zip in *.zip; do
            mv "$zip" "$(basename "$zip" .zip)-x86_64.zip"
          done
          
          # å†æ¬¡æ‰“å°é‡å‘½ååçš„äº§ç‰©ï¼ˆç¡®è®¤ç»“æœï¼‰
          echo "é‡å‘½ååäº§ç‰©åˆ—è¡¨ï¼š"
          ls -l *.tar.gz *.zip

      ##########################################################################
      # æ­¥éª¤7ï¼šä¸Šä¼ Artifactsï¼ˆä¼˜åŒ–æ¡ä»¶åˆ¤æ–­ï¼Œé¿å…ç©ºä¸Šä¼ ï¼‰
      ##########################################################################
      - name: Upload Linux x86_64 æ ‡å‡†åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-linux-x86_64
          path: kkFileView/server/target/*-x86_64.tar.gz
          retention-days: 7
          if-no-files-found: error  # æ— æ–‡ä»¶æ—¶æŠ¥é”™ï¼ˆå¿«é€Ÿå‘ç°æ„å»ºé—®é¢˜ï¼‰

      - name: Upload Windows x86_64 æ ‡å‡†åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-windows-x86_64
          path: kkFileView/server/target/*-x86_64.zip
          retention-days: 7
          if-no-files-found: warn  # WindowsåŒ…å¯èƒ½æœªç”Ÿæˆï¼Œè­¦å‘Šå³å¯

      - name: Upload Linux ARM64 æœ€å°åŒ–åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: kkfileview-linux-arm64-minimal
          path: kkFileView/server/target/*-arm64-minimal.tar.gz
          retention-days: 7
          if-no-files-found: warn  # å…¼å®¹éƒ¨åˆ†åœºæ™¯ä¸‹ARM64äº§ç‰©æœªç”Ÿæˆçš„æƒ…å†µ

      ##########################################################################
      # æ­¥éª¤8ï¼šå‘å¸ƒåˆ°Releasesï¼ˆä¿®å¤æƒé™+ä¼˜åŒ–æ–‡ä»¶åŒ¹é…ï¼‰
      ##########################################################################
      - name: ç”ŸæˆReleaseç‰ˆæœ¬å·
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        id: generate-version
        run: |
          DATE=$(date +%Y%m%d)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "VERSION=daily-build-$DATE-$TIMESTAMP" >> $GITHUB_ENV

      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ äº§ç‰©
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}  # å”¯ä¸€æ ‡ç­¾ï¼ˆé¿å…é‡å¤ï¼‰
          name: æ¯æ—¥æ„å»º-${{ env.VERSION }}
          body: |
            ğŸ“… æ„å»ºæ—¥æœŸï¼š${{ env.VERSION }}
            ğŸ”— æºç æ¥æºï¼škekingcn/kkFileView@master
            ğŸ“¦ åŒ…å«äº§ç‰©ï¼š
            - Linux x86_64 æ ‡å‡†åŒ…ï¼ˆ.tar.gzï¼‰- å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬
            - Windows x86_64 æ ‡å‡†åŒ…ï¼ˆ.zipï¼‰- å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬
            - Linux ARM64 æœ€å°åŒ–åŒ…ï¼ˆ.tar.gzï¼‰- ç²¾ç®€ç‰ˆï¼Œé€‚ç”¨äºARM64è®¾å¤‡ï¼ˆæ ‘è“æ´¾4ã€ARMäº‘æœåŠ¡å™¨ç­‰ï¼‰
            âš ï¸  æ­¤ä¸ºæ¯æ—¥è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œéå®˜æ–¹æ­£å¼å‘å¸ƒï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨
            ğŸ“ æœ€å°åŒ–åŒ…è¯´æ˜ï¼š
            - ç§»é™¤éæ ¸å¿ƒä¾èµ–ã€æ–‡æ¡£ã€ç¤ºä¾‹æ–‡ä»¶ï¼Œå‡å°åŒ…ä½“ç§¯
            - ä¿ç•™æ ¸å¿ƒæ–‡ä»¶é¢„è§ˆåŠŸèƒ½ï¼Œå…¼å®¹ä¸»æµæ ¼å¼ï¼ˆæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰
            - é€‚é…ARM64æ¶æ„ï¼Œé€‚åˆåµŒå…¥å¼/è¾¹ç¼˜è®¾å¤‡éƒ¨ç½²
          draft: false
          prerelease: true
          # ä¼˜åŒ–æ–‡ä»¶åŒ¹é…ï¼šå…è®¸éƒ¨åˆ†æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆé¿å…å› å•ä¸ªäº§ç‰©ç¼ºå¤±å¯¼è‡´Releaseå¤±è´¥ï¼‰
          files: |
            kkFileView/server/target/*-x86_64.tar.gz
            kkFileView/server/target/*-x86_64.zip
            kkFileView/server/target/*-arm64-minimal.tar.gz
          fail_on_unmatched_files: false  # å…³é”®ï¼šä¸åŒ¹é…çš„æ–‡ä»¶ä¸ä¼šå¯¼è‡´Releaseå¤±è´¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
